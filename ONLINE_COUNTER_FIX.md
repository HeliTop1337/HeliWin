# Исправление счетчика онлайн пользователей

## Проблема
Счетчик онлайн показывал количество подключений (вкладок), а не уникальных пользователей. Если один пользователь открывал сайт в нескольких вкладках, онлайн увеличивался на количество вкладок.

## Решение
Реализована система отслеживания уникальных пользователей по IP-адресу:

### Изменения в WebSocket Gateway

1. **Новая структура данных:**
```typescript
private onlineUsers = new Map<string, string>(); // socketId -> userId
private onlineIPs = new Map<string, Set<string>>(); // IP -> Set of socketIds
```

2. **Отслеживание по IP:**
- При подключении клиента извлекается его IP-адрес
- Socket ID добавляется в Set для этого IP
- Один IP может иметь несколько подключений (вкладок)

3. **Подсчет уникальных пользователей:**
- Считается количество уникальных IP-адресов (`onlineIPs.size`)
- Не важно, сколько вкладок открыто с одного IP

### Функция получения IP-адреса

```typescript
private getClientIP(client: Socket): string {
  // Проверяем заголовки прокси
  const forwarded = client.handshake.headers['x-forwarded-for'];
  const realIP = client.handshake.headers['x-real-ip'];
  
  // Нормализуем localhost адреса
  // ::1, ::ffff:127.0.0.1, 127.0.0.1 -> 'localhost'
  
  // Убираем IPv6 префикс для IPv4 адресов
  // ::ffff:192.168.1.1 -> 192.168.1.1
}
```

### Обработка подключений

**При подключении:**
1. Извлекается IP клиента
2. Socket ID добавляется в Set для этого IP
3. Отправляется обновленный счетчик всем клиентам

**При отключении:**
1. Socket ID удаляется из Set для IP
2. Если у IP больше нет активных подключений, IP удаляется
3. Отправляется обновленный счетчик всем клиентам

## Преимущества

1. **Точный подсчет:** Один пользователь = один онлайн, независимо от количества вкладок
2. **Поддержка прокси:** Корректно работает с заголовками `x-forwarded-for` и `x-real-ip`
3. **Нормализация IP:** Различные форматы localhost (IPv4, IPv6) считаются как один IP
4. **Очистка памяти:** Автоматическое удаление IP без активных подключений

## Тестирование

### До исправления:
- Открыто 2 вкладки → Онлайн: 2
- Открыто 5 вкладок → Онлайн: 5

### После исправления:
- Открыто 2 вкладки с одного IP → Онлайн: 1
- Открыто 5 вкладок с одного IP → Онлайн: 1
- Открыто 3 вкладки с IP1 + 2 вкладки с IP2 → Онлайн: 2

## Логирование

Теперь в логах видно:
```
Client connected: <socketId> from IP: <ip>
User <userId> is online from IP <ip>. Total unique IPs: <count>
Broadcasting online count: <count> unique IPs
```

## Файлы изменены:
- `backend/websocket/websocket.gateway.ts`
